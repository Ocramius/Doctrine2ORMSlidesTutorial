<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Doctrine 2 ORM Tutorial</title>
        
        <!-- jQuery + history plugin -->
        <script type="text/javascript" src="vendor/slippy/src/jquery.min.js"></script>
        <script type="text/javascript" src="vendor/slippy/src/jquery.history.js"></script>

        <!-- Slippy core js file -->
        <script type="text/javascript" src="vendor/slippy/src/slippy.js"></script>

        <!-- Slippy structural styles -->
        <link type="text/css" rel="stylesheet" href="vendor/slippy/src/slippy.css"/>

        <!-- Slippy theme (feel free to change it) -->
        <link type="text/css" rel="stylesheet" href="vendor/slippy/src/slippy-pure.css"/>
        
        <!-- Syntax highlighting core file  -->
        <script type="text/javascript" src="vendor/slippy/src/highlighter/shCore.js"></script>

        <!-- Syntax highlighting brushes, this one is only for php -->
        <script type="text/javascript" src="vendor/slippy/src/highlighter/shBrushPhp.js"></script>
        <script type="text/javascript" src="vendor/slippy/src/highlighter/shBrushBash.js"></script>

        <!-- Syntax highlighting core CSS and a theme -->
        <link type="text/css" rel="stylesheet" href="vendor/slippy/src/highlighter/shCore.css"/>
        <link type="text/css" rel="stylesheet" href="vendor/slippy/src/highlighter/shThemeEclipse.css"/>
        
        <script type="text/javascript">
            $(function() {
                $(".slide").slippy({});
                SyntaxHighlighter.all();
            });
        </script>
        <style type="text/css">
            pre {
                font-size: 60%;
                line-height: 0.8;
            }
            .pro {
                color: #008200;
            }
            .cons {
                color: #ff0000;
            }
        </style>
    </head>
    <body>
        <div class="slide" style="text-align: center;">
            <h1>Doctrine 2 ORM</h1>
            <h3>Object Relational Mapper for PHP 5.3</h3>
            <p style="padding-top: 20px;">
                <img src="image/common_icon.png" alt="Doctrine"/>
            </p>
        </div>
        <div class="slide">
            <h2>Some history of RDBMS persistence in PHP:</h2>
            <ol>
                <li>mysql_query, mysql_fetch_array, mysql_*</li>
                <li>mysqli, PDO</li>
                <li>Doctrine 1.2, Propel 1.6, Zend_Db</li>
            </ol>
        </div>
        <div class="slide">
            <h2>mysql_query</h2>
        </div>
        <div class="slide">
            <pre class="brush: php">
mysql_connect('localhost', 'user', 'password');
mysql_select_db('test');
mysql_query('INSERT INTO greetings (content) VALUES ("' . mysql_real_escape_string($_POST['greeting']) . '")');
mysql_query('INSERT INTO persons (greeting_id, name) VALUES (' . mysql_insert_id() . ', "' . mysql_real_escape_string($_POST['person']) . '")');
            </pre>
        </div>
        <div class="slide">
            <h3>mysql_query</h3>
            <ul>
                <li class="cons">
                    We had to write our queries and our security (mysql_real_escape_string()) by ourselves.
                </li>
                <li class="cons">
                    Also, we had to keep track of identifiers of the inserted fields by ourselves.
                </li>
                <li class="cons">
                    We had to rewrite every function name (and probably also functionality) when switching database vendor.
                </li>
                <li class="cons">
                    Not really OO friendly, heh?
                </li>
            </ul>
        </div>
        <div class="slide">
            <h2>PDO</h2>
        </div>
        <div class="slide">
            <pre class="brush: php">
try {
    $dbh = new PDO('mysql:host=localhost;dbname=test', 'user', 'password');
    $sth = $dbh-&gt;prepare('INSERT INTO greetings (content) VALUES (:content);
    $sth-&gt;execute(array(':content' =&gt; $_POST['content']));
    $sth = $dbh-&gt;prepare('INSERT INTO persons (greeting_id, name) VALUES (:greeting_id, :name)');
    $sth-&gt;execute(array(':greeting_id' =&gt; $dbh-&gt;lastInsertId(), ':name' =&gt; $_POST['name']);
} catch (PDOException $e) {
    echo $e-&gt;getMessage();
}
            </pre>
        </div>
        <div class="slide">
            <h3>PDO</h3>
            <ul>
                <li class="pro">
                    We now can connect to different databases. MySQL is no more the only option!
                </li>
                <li class="pro">
                    Security is given by named parameters, escaped for us by PDO!
                </li>
                <li class="pro">
                    Prepared statements make our queries easier to reuse!
                </li>
                <li class="pro">
                    Exceptions are used, we can now catch them!
                </li>
                <li class="cons">
                    Queries are still performed in the SQL dialect of the vendor, which could make our code not 100% portable.
                </li>
                <li class="cons">
                    Still have to keep track of identifiers of the inserted fields by ourselves.
                </li>
            </ul>
        </div>
        <div class="slide">
            <h2>Doctrine 1.2</h2>
            <p>An Active Record implementation</p>
        </div>
        <div class="slide">
            <pre class="brush: php">
class Greeting extends Doctrine_Record
{
    public function setTableDefinition()
    {
        $this-&gt;setTableName('greetings');
        $this-&gt;hasColumn(
            'content',
            'string',
            255,
            array(
                'type' =&gt; 'string',
                'length' =&gt; '255'
            )
        );
    }
    
    public function setUp()
    {
        $this-&gt;hasMany(
            'Person as Person',
            array(
                'refClass' =&gt; 'Person',
                'local' =&gt; 'greeting_id',
                'foreign' =&gt; 'person_id'
            )
        );
    }
}
            </pre>
        </div>
        <div class="slide">
            <pre class="brush: php">
class Person extends Doctrine_Record
{
    public function setTableDefinition()
    {
        $this-&gt;setTableName('persons');
        $this-&gt;hasColumn(
            'name',
            'string',
            255,
            array(
                'type' =&gt; 'string',
                'length' =&gt; '255'
            )
        );
        $this-&gt;hasColumn(
            'greeting_id',
            'string',
            255,
            array(
                'type' =&gt; 'string',
                'length' =&gt; '255'
            )
        );
    }
    
    public function setUp()
    {
        $this-&gt;hasOne(
            'Greeting',
            array(
                'refClass' =&gt; 'Greeting',
                'local' =&gt; 'greeting_id',
                'foreign' =&gt; 'id'
            )
        );
    }
}
            </pre>
        </div>
        <div class="slide">
            <pre class="brush: php">
$greeting = new Greeting();
$greeting-&gt;content = $_POST['content'];
$greeting-&gt;save();
$person = new Person();
$person-&gt;name = $_POST['name'];
$person-&gt;Greeting = $greeting;
$greeting-&gt;Person[] = $person;
$greeting-&gt;save();
            </pre>
        </div>
        <div class="slide">
            <h3>Doctrine 1.2</h3>
            <ul>
                <li class="pro">
                    Objects are written to DB by Doctrine: no more SQL!
                </li>
                <li class="pro">
                    Object-Oriented approach!
                </li>
                <li class="pro">
                    Database is abstracted by a powerful DBAL layer: no more SQL portability troubles!
                </li>
                <li class="pro">
                    Database can be generated by our models!
                </li>
                <li class="cons">
                    Table definition is set in our domain logic.
                </li>
                <li class="cons">
                    A lot of PHP "magic" is happening (__set, __get, etc.).
                </li>
                <li class="cons">
                    Our objects must extend Doctrine_Record to be used with Doctrine
                </li>
            </ul>
        </div>
        <div class="slide">
            <h2>What is Doctrine 2?</h2>
            <p>
                Doctrine 2 is a Data Mapper implementation:
            </p>
            <p style="margin: 10px;">
                <img src="image/databaseMapperSketch.gif" alt="Data Mapper" width="60%"/>
            </p>
            <p>
                It separates persistence and domain logic. You are now able to port your logic to SQL, NoSQL, XML mappers, etc.
            </p>
            <p>
                It provides around 3X better performance than Doctrine 1.2.
            </p>
            <p>
                Your objects won't need to extend anything.
            </p>
            <p>
                You are free to save anything you want to your database, just map it!
            </p>
            <p>
                You can even map existing classes to database tables!
            </p>
        </div>
        <div class="slide">
            <h2>Doctrine 2 Requirements</h2>
            <p>
                PHP 5.3
            </p>
            <p>
                Doctrine\Common library (bundled)
            </p>
            <p>
                Doctrine\DBAL library (bundled)
            </p>
            <p>
                Symfony\Component\Console (bundled)
            </p>
            <p>
                Symfony\Component\Yaml (bundled, used if you need YAML configuration)
            </p>
            <p>
                Autoloading (provided by Doctrine\Common, but you can use your own implementation)
            </p>
        </div>
        <div class="slide">
            <h2>Getting started</h2>
            <pre class="brush: bash">
mkdir doctrine-demo
cd doctrine-demo
mkdir library
mkdir library/Entity
touch library/Entity/Greeting.php
touch library/Entity/Person.php
mkdir library/EntityProxy
chmod +w library/EntityProxy
git clone https://github.com/doctrine/doctrine2.git --recursive library/doctrine-orm
touch bootstrap.php
            </pre>
        </div>
        <div class="slide">
            <h2>Create entities...</h2>
        </div>
        <div class="slide">
            <pre class="brush: php">
namespace Entity;

use Entity\Person;

class Greeting
{
    /** @var int */
    private $id;
    
    /** @var string */
    private $content;
    
    /** @var Person[] */
    private $persons;
    
}
            </pre>
        </div>
        <div class="slide">
            <pre class="brush: php">
namespace Entity;

use Entity\Greeting;

class Person
{
    
    /** @var int */
    private $id;
    
    /** @var string */
    private $name;
    
    /** @var Greeting */
    private $greeting;
    
}
            </pre>
        </div>
        <div class="slide">
            <h2>...add getters, setters, constructors, other methods...</h2>
        </div>
        <div class="slide">
            <pre class="brush: php">
namespace Entity;

use Doctrine\Common\Collections\Collection,
    Doctrine\Common\Collections\ArrayCollection,
    Entity\Person;

class Greeting
{
    
    /** @var int */
    private $id;
    
    /** @var string */
    private $content;
    
    /** @var Collection */
    private $persons;
    
    public function <strong>__construct($content)</strong> {
        <strong>//We use ArrayCollections instead of a simple arrays in Doctrine</strong>
        $this->persons = new ArrayCollection();
        $this->setContent($content);
    }
    
    /**
     * @return int
     */
    public function <strong>getId()</strong> {
        return $this->id;
    }
    
    /**
     * @return string
     */
    public function <strong>getContent()</strong> {
        return $this->content;
    }
    
    /**
     * @param string $content
     */
    public function <strong>setContent($content)</strong> {
        $this->content = (string) $content;
    }
    
    /**
     * @return Collection
     */
    public function <strong>getPersons()</strong> {
        return $this->persons;
    }
    
    /**
     * @param Person $person
     */
    public function <strong>addPerson(Person $person)</strong> {
        $this->persons->add($person);
        $person->setGreeting($this);
    }

}
            </pre>
        </div>
        <div class="slide">
            <pre class="brush: php">
namespace Entity;

use Entity\Greeting;

class Person
{
    
    /** @var int */
    private $id;
    
    /** @var string */
    private $name;
    
    /** @var Greeting */
    private $greeting;
    
    public function <strong>__construct(Greeting $greeting, $name)</strong> {
        $this->setName($name);
        $this->setGreeting($greeting);
    }
    
    /**
     * @return int
     */
    public function <strong>getId()</strong> {
        return $this->id;
    }
    
    /**
     * @return string
     */
    public function <strong>getName()</strong> {
        return $this->name;
    }
    
    /**
     * @param string $name
     */
    public function <strong>getName($name)</strong> {
        $this->name = (string) $name;
    }
    
    /**
     * @return Greeting
     */
    public function <strong>getGreeting()</strong> {
        return $this->greeting;
    }
    
    /**
     * @param Greeting $greeting
     */
    public function <strong>addPerson(Greeting $greeting)</strong> {
        $this->greeting = $greeting;
    }

}
            </pre>
        </div>
        <div class="slide">
            <h2>...add mappings (@Annotations) to entities...</h2>
        </div>
        <div class="slide">
            <pre class="brush: php">
namespace Entity;

use Doctrine\Common\Collections\Collection,
    Doctrine\Common\Collections\ArrayCollection,
    Entity\Person;

class Greeting
{
    
    /**
     * <strong>@Id()</strong>
     * <strong>@Column(type="integer")</strong>
     * <strong>@GeneratedValue(strategy="auto")</strong>
     * @var int
     */
    private $id;
    
    /**
     * <strong>@Column(type="string", length=255)</strong>
     * @var string
     */
    private $content;
    
    /**
     * <strong>@OneToMany(targetEntity="Entity\Person", mappedBy="greeting")</strong>
     * @var Collection
     */
    private $persons;
    
    public function __construct($content) {
        $this->persons = new ArrayCollection();
        $this->setContent($content);
    }
    
    /**
     * @return int
     */
    public function getId() {
        return $this->id;
    }
    
    /**
     * @return string
     */
    public function getContent() {
        return $this->content;
    }
    
    /**
     * @param string $content
     */
    public function setContent($content) {
        $this->content = (string) $content;
    }
    
    /**
     * @return Collection
     */
    public function getPersons() {
        return $this->persons;
    }
    
    /**
     * @param Person $person
     */
    public function addPerson(Person $person) {
        $this->persons->add($person);
        $person->setGreeting($this);
    }

}
            </pre>
        </div>
        <div class="slide">
            <pre class="brush: php">
namespace Entity;

use Entity\Greeting;

class Person
{
    
    /**
     * <strong>@Id()</strong>
     * <strong>@Column(type="integer")</strong>
     * <strong>@GeneratedValue(strategy="auto")</strong>
     * @var int
     */
    private $id;
    
    /**
     * <strong>@Column(type="string", length=255)</strong>
     * @var string
     */
    private $name;
    
    /**
     * <strong>@ManyToOne(targetEntity="Entity\Greeting", inversedBy="persons")</strong>
     * @var Greeting
     */
    private $greeting;
    
    public function __construct(Greeting $greeting, $name) {
        $this->setName($name);
        $this->setGreeting($greeting);
    }
    
    /**
     * @return int
     */
    public function getId() {
        return $this->id;
    }
    
    /**
     * @return string
     */
    public function getName() {
        return $this->name;
    }
    
    /**
     * @param string $name
     */
    public function getName($name) {
        $this->name = (string) $name;
    }
    
    /**
     * @return Greeting
     */
    public function getGreeting() {
        return $this->greeting;
    }
    
    /**
     * @param Greeting $greeting
     */
    public function addPerson(Greeting $greeting) {
        $this->greeting = $greeting;
    }

}
            </pre>
        </div>
        <div class="slide">
            <h2>Creating an EntityManager</h2>
        </div>
        <div class="slide">
            <h3>Autoloading:</h3>
            <pre class="brush: php">
&lt;?php
// bootstrap.php
use Doctrine\ORM\Tools\Setup,
    Doctrine\ORM\EntityManager,
    Doctrine\ORM\Configuration,
    Doctrine\Common\Cache\ArrayCache as Cache;

//autoloading
require_once 'library/doctrine-orm/lib/Doctrine/ORM/Tools/Setup.php';
Setup::registerAutoloadGit(__DIR__ . 'library/doctrine-orm');
            </pre>
        </div>
        <div class="slide">
            <h3>Configuration and metadata</h3>
            <pre class="brush: php">
//configuration
$config = new Configuration();
$cache = new Cache();
$config-&gt;setQueryCacheImpl($cache);
$config-&gt;setProxyDir(__DIR__ . '/library/EntityProxy');
$config-&gt;setProxyNamespace('EntityProxy');
$config-&gt;setAutoGenerateProxyClasses(true);

//mapping (example uses annotations, could be any of XML/YAML or plain PHP)
$driverImpl = $config-&gt;newDefaultAnnotationDriver(__DIR__ . '/library/Entity');
$config-&gt;setMetadataDriverImpl($cache);
$config-&gt;setMetadataCacheImpl($cache);
            </pre>
        </div>
        <div class="slide">
            <h3>Creating the EntityManager</h3>
            <pre class="brush: php">
//getting the EntityManager
$em = EntityManager::create(
    array(
        'driver' =&gt; 'pdo_sqlite',
        'path' =&gt; 'database.sqlite'
    ),
    $config
);
            </pre>
        </div>
        <div class="slide">
            <h3>Final result:</h3>
            <pre class="brush: php">
&lt;?php
// bootstrap.php
use Doctrine\ORM\Tools\Setup,
    Doctrine\ORM\EntityManager,
    Doctrine\ORM\Configuration,
    Doctrine\Common\Cache\ArrayCache as Cache;

//autoloading
require_once 'library/doctrine-orm/lib/Doctrine/ORM/Tools/Setup.php';
Setup::registerAutoloadGit(__DIR__ . 'library/doctrine-orm');

//configuration
$config = new Configuration();
$cache = new Cache();
$config-&gt;setQueryCacheImpl($cache);
$config-&gt;setProxyDir(__DIR__ . '/library/EntityProxy');
$config-&gt;setProxyNamespace('EntityProxy');
$config-&gt;setAutoGenerateProxyClasses(true);

//mapping (example uses annotations, could be any of XML/YAML or plain PHP)
$driverImpl = $config-&gt;newDefaultAnnotationDriver(__DIR__ . '/library/Entity');
$config-&gt;setMetadataDriverImpl($cache);
$config-&gt;setMetadataCacheImpl($cache);

//getting the EntityManager
$em = EntityManager::create(
    array(
        'driver' =&gt; 'pdo_sqlite',
        'path' =&gt; 'database.sqlite'
    ),
    $config
);
            </pre>
        </div>
        <div class="slide">
            <h2>Generating the schema</h2>
        </div>
    </body>
</html>
